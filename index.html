<!doctype html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset="UTF-8">
	<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" href="20170405MusicPlayer.css">
	<title>MusicPlayer</title>
</head>
<body>
	<input type="file" id="file" accept="audio/mp3,audio/ogg" multiple>
	<article id="music_player">
		<audio id="player"></audio>
		<section id="content">
			<div id="album_image">
				<img src="image/1.jpg" id="image">
			</div>
			
		<span id="add_music" title="添加音乐">
			<i class="fa fa-upload" aria-hidden="true"></i>
		</span>
		
		<div class="notice">
			<h2 id="music_title">曲名/Title</h2>
			<p id="music_singer">演唱者/Singer</p>
		</div>

		<div id="music_control">
			<button id="music_stop">
				<i class="fa fa-play" aria-hidden="true" id="control_icon"></i>
			</button>
			<button id="music_pre" title="上一首">
				<i class="fa fa-fast-backward" aria-hidden="true"></i>
			</button>
			<button id="music_next" title="下一首">
				<i class="fa fa-fast-forward" aria-hidden="true"></i>
			</button>
			
			<div id="sound_icon">
				<i class="fa fa-volunme-up" aria-hidden="true" id="volume"></i>
				<i class="fa fa-minus-circle" aria-hidden="true" id="volume_down" title="调低"></i>
				<progress value="10" max="10" id="music_sound"></progress>
				<i class="fa fa-plus-circle" aria-hidden="true" id="volume_up" title="调高"></i>
			</div>
		</div>
		</section>
		<aside>
			<div><progress value="0" max="100" id="music_progress"></progress></div>
			<span id="current_time">0:00</span><span id="duration">/0:00</span>
			<img src="image/loop.png" id="play_style_loop" title="顺序播放" class="">
			<img src="image/random.png" id="play_style_random" title="随机播放" class="hidden">
		</aside>
	</article>
	<article id="music_list">
	<ul id="musics"></ul>
	</article>
	<script>
	/*
 * @Author: MengjieLee
 * @Date:   2017-04-05 13:35:53
 * @Last Modified by:   MengjieLee
 * @Last Modified time: 2017-04-05 18:19:19
 */

(function() {
	var musicControl = document.getElementById("music_stop"),//article buttom
		player = document.getElementById("player"),//audio
		controlIcon = document.getElementById("control_icon"),//播放/暂停控制 i
		durationElement = document.getElementById("duration"),//总播放时间 span
		currentTimeElement = document.getElementById("current_time"),//现播放时间 span
		progressElement = document.getElementById("music_progress"),//播放进度条 progress
		volumeUpElement = document.getElementById("volume_up"),//调高音量 i
		volumeDownElement = document.getElementById("volume_down"),//调低音量 i
		volumeProgress = document.getElementById("music_sound"),//音量进度条 progress
		fileElement = document.getElementById("file"),//上传音乐 input
		nextElement = document.getElementById("music_next"),//下一首 buttom
		preElement = document.getElementById("music_pre"),//上一首 buttom
		musicTitleElement = document.getElementById("music_title"),//曲名 h2
		addMusicElement = document.getElementById("add_music"),//添加音乐 span
		albumPicElment = document.getElementById("image"),//封面图 img
		musicPlayer = document.getElementById("music_player"),//article
		musicUL = document.getElementById("musics"),//播放列表 
		loopElement = document.getElementById("play_style_loop"),//顺序播放 img
		randomElement = document.getElementById("play_style_random"),//随机播放 img
		liElementsCache = [];//数组对象

	/* music queue to save and get music to play */
	function MusicQueue() {
		var musics = [];
		var index = -1;
		var loop = true;

		this.setLoop = function() {
			loop = true;
		};

		this.setRandom = function() {
			loop = false;
		};

		this.addMusic = function(music) {
			musics.push(music);
		};

		this.addList = function(list) {
			var length = list.length;

			for(var i = 0; i < length; i++) {
				this.addMusic(list[i]);
			}
		};

		this.getMusic = function() {
			if(loop === true) {
				if(index >= musics.length - 1) {
					index = -1;
				}
				index += 1;
				return musics[index];
			} else {
				index = Math.floor(Math.random() * musics.length);
				return musics[index];
			}
		};

		this.getPreMusic = function() {
			if(loop) {
				if(index === 0) {
					return musics[0];
				} else {
					index -= 1;
					return musics[index];
				}
			} else {
				return this.getMusic();
			}
		};

		this.getMusicByName = function(name) {
			index = this.getIndexByName(name);
			return musics[index];
		};

		this.getIndexByName = function(name) {
			for(var i = 0; i < musics.length; i++) {
				if(musics[i].name === name) {
					return i;
				}
			}
		}

		this.getAllMusic = function() {
			return musics;
		};

		this.pushMusics = function(ms) {
			musics = ms;
		};
	}
	/* music queue end */

	/* init view */
	var musicQueue = new MusicQueue(),
		index = 0;

	(function init() {
		var music = new Music("谁愿放手", "music/陈慧琳-谁愿放手.mp3");
		musicQueue.addMusic(music);
		musicTitleElement.innerHTML = music.name;
		player.src = music.src;
		setTimeout(setDuration, 500);
		appendMusicToDOM("谁愿放手");
		setSelected(index);
	})();
	/* end init view */

	/* register event handler */
	loopElement.addEventListener("click", function(event) {
		musicQueue.setRandom();
		randomElement.classList.remove("hidden");
		loopElement.classList.add("hidden");
	},false);

	randomElement.addEventListener("click", function(event) {
		musicQueue.setLoop();
		loopElement.classList.remove("hidden");
		randomElement.classList.add("hidden");
	}, false);

	// next music logic
	nextElement.addEventListener("click", function(event) {
		preparePlay(musicQueue.getMusic());
	}, false);

	// pre music logic
	preElement.addEventListener("click", function(event) {
		preparePlay(musicQueue.getPreMusic());
	},false);

	musicPlayer.addEventListener("dragover", function(e) {
		e.preventDefault();
	});

	
	musicPlayer.addEventListener("drop", readData, false);
	function readData(e) {
		e.preventDefault();
		var filelist = e.dataTransfer.files;
		if (!filelist) { return; }

		if (filelist.length > 0) {
			var file = filelist[0];
			if((file.type).indexOf("audio") !== -1 && file.size > 8094) {
				musicQueue.addMusic(getMusic(file));
				appendMusicToDOM(file.name);
			}
		}
	}

	var timeId;

	musicControl.addEventListener("click", function() {
		if (player.paused) {
			player.play();
			start();
			timeId = setTimeout(change, 500);
		} else {
			player.pause();
			pause();
			clearTimeout(timeId);
		}
	});

	player.addEventListener("ended", function() {
		var music = musicQueue.getMusic();
		removeSelected(index);
		preparePlay(music);
	});

	volumeDownElement.addEventListener("click", function() {
		var volume = player.volume;
		player.volume = (volume - 0.2 >= 0) ? volume - 0.2 : 0;
		volumeProgress.value = player.volume * 10;
	});

	volumeUpElement.addEventListener("click", function() {
		var volume = player.volume;
		player.volume = (volume + 0.2 <= 1) ? volume + 0.2 : 1;
		volumeProgress.value = player.volume * 10;
	});

	volumeProgress.addEventListener("click", function(event) {
		var t = (event.offsetX / 100).toFixed(1);
		player.volume = t;
		volumeProgress.value = t*10;
	},false);

	fileElement.addEventListener("change", function(event) {

		var files = fileElement.files;
		for(var i = 0; i < files.length; i++) {
			if((files[i].type).indexOf("audio") !== -1 && files[i].size > 8094) {
				var music = getMusic(files[i]);
				musicQueue.addMusic(music);
				appendMusicToDOM(music.name);
			}

		}
	});

	addMusicElement.addEventListener("click", function(event) {
		fileElement.click();
	});

	// set current time by progress element in dom
	progressElement.addEventListener("click", function(event) {
		var t = (event.offsetX / 470).toFixed(2);
		var currentTime = player.duration * t;
		player.currentTime = currentTime;
		change();
	},false);

	musics.addEventListener("dblclick", function(event) {
		var name = event.target.innerHTML;
		preparePlay(musicQueue.getMusicByName(name));
	},false);
	/* end register event handler */

	function start() {
		// change icon
		controlIcon.classList.remove("fa-play");
		controlIcon.classList.add("fa-pause");

		setDuration();
	}

	function pause() {
		controlIcon.classList.remove("fa-pause");
		controlIcon.classList.add("fa-play");
	}

	function preparePlay(music) {
		musicTitleElement.innerHTML = music.name;
		player.src = music.src;

		start();
		changeImage();
		setCurrentTime();

		player.play();
		setTimeout(setDuration, 500);
		clearTimeout(timeId);
		timeId = setTimeout(change, 500);

		removeSelected(index);
		index = musicQueue.getIndexByName(music.name);
		setSelected(index);
	}

	// set music total time in dom
	function setDuration() {
		var total = player.duration;
		total = total ? total : 0;
		durationElement.innerHTML = "/ " + timeFormat(total);
	}

	// set the current time of music in dom
	function setCurrentTime() {
		var total = player.currentTime;
		currentTimeElement.innerHTML = timeFormat(total);
	}

	// transform time format to hh:mm
	function timeFormat(total) {
		var minute = parseInt(total / 60),
			second = parseInt(total - minute * 60),
			result;

		second = (second >= 10) ? second : '0' + second;
		result = minute + ":" + second;
		return result;
	}

	// update the progress
	function change() {
		setCurrentTime();
		var currentTime = player.currentTime,
			duration = player.duration;

		var progress = (currentTime / duration).toFixed(2) * 100;
		progress = progress <= 100 ? progress : 100;
		progressElement.value = progress;

		timeId = setTimeout(change, 500);
	}

	function getMusic(file) {
		var url = URL.createObjectURL(file);
		return new Music(file.name, url);
	}

	function Music(name, src) {
		this.name = name;
		this.src = src;
	}

	function changeImage() {
		var num = parseInt(Math.random() * 5),
			src;	

		num = (num > 0) ? num : num + 1;
		src = "image/" + num + ".jpg";
		albumPicElment.src = src;
	}

	function appendMusicToDOM(name) {
		var li = document.createElement("li");
		var text = document.createTextNode(name);
		li.appendChild(text);
		liElementsCache.push(li);
		musicUL.appendChild(li);
	}

	function setSelected(index) {
		liElementsCache[index].classList.add("selected");
		liElementsCache[index].scrollIntoView(false);
	}

	function removeSelected(index) {
		liElementsCache[index].classList.remove("selected");
	}
})();
	</script>
	
</body>
</html>